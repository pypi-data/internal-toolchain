name: 'PyPi-data toolchain'
description: 'PyPi-data toolchain'
inputs:
  push:
    description: 'Push ref?'
    required: false
    default: 'true'
  limit:
    description: 'Limit'
    required: false
    default: '5000'
  token:
    description: 'Github token'
    required: true
  workspace:
    description: 'Path to github workspace'
    required: true
  run-id:
    description: 'Github actions run ID'
    required: true
outputs: {}
runs:
  using: "composite"
  steps:
    - uses: robinraju/release-downloader@v1.8
      with:
        repository: "pypi-data/toolchain"
        fileName: "pypi-data-toolchain.tar.gz"
        extract: true
        latest: true
        out-file-path: "toolchain"
    - shell: bash
      run: |
        ${{ inputs.workspace }}/toolchain/pypi-data-toolchain --version

    - shell: bash
      run: |
        ${{ inputs.workspace }}/toolchain/pypi-data-toolchain extract ${{ inputs.workspace }} \ 
          --limit=${{ inputs.limit }} \
          --index-file-name=index-${{ inputs.run-id }}.parquet \
        | git fast-import --force --max-pack-size=200M

    - shell: bash
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add index.json
        git commit -m "Add changes"
        
        git log -n 1 code

    - name: push code
      shell: bash
      run: |
        git config http.postBuffer 524288000
        du -hs .git/objects/pack/*
        git -C ${{ inputs.workspace }} push --atomic origin refs/heads/code:refs/heads/code +main:main

    - name: Publish
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        name: "Index"
        tag_name: "latest"
        files: 'index-${{ inputs.run-id }}.parquet'
        token: ${{ inputs.token }}
